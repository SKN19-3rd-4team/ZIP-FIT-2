# ê°œë°œ ë°©í–¥ ë³€ê²½ì‚¬í•­ (ê¸´ê¸‰)

> **íŒ€ì› í”¼ë“œë°± ë°˜ì˜ - API ê¸°ë°˜ ê°œë°œë¡œ ì „í™˜**

---

## âš ï¸ ì¤‘ìš” ë³€ê²½ì‚¬í•­

### 1. Django Session ì €ì¥ ë°©ì‹ ë³€ê²½ âŒ

**ê¸°ì¡´ ê³„íš**: Django sessionì— user_key, session_key ì €ì¥
**ë³€ê²½ ì‚¬í•­**: **Django session ì €ì¥ ë°©ì‹ ì‚¬ìš© ì•ˆ í•¨**

**ì´ìœ **:
- ë°±ì—”ë“œ APIê°€ user_key, session_keyë§Œ ë°›ì•„ì„œ ì²˜ë¦¬
- ì±„íŒ… íˆìŠ¤í† ë¦¬ëŠ” APIì—ì„œ user_keyë¡œ ì¡°íšŒ
- ì„¸ì…˜ ê´€ë¦¬ëŠ” í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì²˜ë¦¬

---

## ğŸ”„ ìƒˆë¡œìš´ ê°œë°œ ë°©í–¥

### 1. user_key ë° session_key ê´€ë¦¬

**ë°©ì‹**: **í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ê´€ë¦¬ (localStorage ë˜ëŠ” sessionStorage)**

**êµ¬í˜„ ë°©ë²•**:
```javascript
// JavaScript (í”„ë¡ íŠ¸ì—”ë“œ)
// user_key ìƒì„± (ìµœì´ˆ ì ‘ì† ì‹œ)
function getOrCreateUserKey() {
    let userKey = localStorage.getItem('user_key');
    if (!userKey) {
        // APIì—ì„œ user_key ìƒì„± ìš”ì²­ ë˜ëŠ” í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ìƒì„±
        userKey = generateUserKey(); // ë˜ëŠ” API í˜¸ì¶œ
        localStorage.setItem('user_key', userKey);
    }
    return userKey;
}

// session_key ìƒì„± (ìƒˆ ì±„íŒ… ì‹œì‘ ì‹œ)
function createSessionKey() {
    const sessionKey = generateUUID();
    sessionStorage.setItem('current_session_key', sessionKey);
    return sessionKey;
}
```

**ë˜ëŠ” APIì—ì„œ ìƒì„±**:
- `/api/docs`ì—ì„œ user_key ìƒì„± API í™•ì¸ í•„ìš”
- APIì—ì„œ ìƒì„±í•œë‹¤ë©´ í•´ë‹¹ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ

---

### 2. ì±„íŒ… íˆìŠ¤í† ë¦¬ ì¡°íšŒ

**ê¸°ì¡´**: Django sessionì—ì„œ ì¡°íšŒ
**ë³€ê²½**: **API í˜¸ì¶œë¡œ ì¡°íšŒ**

**API ì—”ë“œí¬ì¸íŠ¸**:
- `/api/chathistories?user_key={user_key}` - íˆìŠ¤í† ë¦¬ ëª©ë¡ ì¡°íšŒ
- `/api/chathistories/{session_key}?user_key={user_key}` - íŠ¹ì • íˆìŠ¤í† ë¦¬ ìƒì„¸ ì¡°íšŒ

**êµ¬í˜„ ë°©ë²•**:
```javascript
// ì±„íŒ… íˆìŠ¤í† ë¦¬ ëª©ë¡ ì¡°íšŒ
async function getChatHistories(userKey) {
    const response = await fetch(`/api/chathistories?user_key=${userKey}`);
    const data = await response.json();
    return data.data; // [{title, session_key}, ...]
}

// íŠ¹ì • íˆìŠ¤í† ë¦¬ ì¡°íšŒ
async function getChatHistoryDetail(sessionKey, userKey) {
    const response = await fetch(`/api/chathistories/${sessionKey}?user_key=${userKey}`);
    const data = await response.json();
    return data.data; // {title, session_key, user_key, chat_list: [...]}
}
```

---

### 3. ì‚¬ìš©ì ID ìƒì„± ë°©ì‹

**ê¸°ì¡´**: `web/utils.py`ì—ì„œ ìƒì„± (625ê°€ì§€ ì¡°í•©)
**ë³€ê²½**: **APIì—ì„œ ìƒì„± ë˜ëŠ” í™•ì¸ í•„ìš”**

**í™•ì¸ í•„ìš”**:
- `/api/docs`ì—ì„œ user_key ìƒì„± API í™•ì¸
- APIì—ì„œ ìƒì„±í•œë‹¤ë©´ í•´ë‹¹ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
- APIì—ì„œ ìƒì„±í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ìƒì„± í›„ localStorage ì €ì¥

---

## ğŸ“‹ API ì—”ë“œí¬ì¸íŠ¸ ì •ë¦¬

### í™•ì¸ëœ API

1. **POST `/api/chat`** - ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ ë° AI ì‘ë‹µ
   - ìš”ì²­: `{user_key, session_key, user_message}`
   - ì‘ë‹µ: `{status, message, data: {ai_response: {...}}}`

2. **GET `/api/chathistories`** - ì±„íŒ… íˆìŠ¤í† ë¦¬ ëª©ë¡
   - íŒŒë¼ë¯¸í„°: `user_key` (query)
   - ì‘ë‹µ: `{status, message, data: [{title, session_key}, ...]}`

3. **GET `/api/chathistories/{session_key}`** - íŠ¹ì • íˆìŠ¤í† ë¦¬ ìƒì„¸
   - íŒŒë¼ë¯¸í„°: `session_key` (path), `user_key` (query)
   - ì‘ë‹µ: `{status, message, data: {title, session_key, user_key, chat_list: [...]}}`

4. **GET `/api/anncs`** - ê³µê³  ëª©ë¡ ì¡°íšŒ
   - íŒŒë¼ë¯¸í„°: `annc_title`, `annc_status`, `annc_type`, `items_per_page`, `current_page`

5. **GET `/api/annc_summary`** - ê³µê³  ìš”ì•½ ì •ë³´
   - ì‘ë‹µ: `{status, message, data: {cnt_total, cnt_lease, cnt_sale, cnt_etc}}`

### í™•ì¸ í•„ìš” API

- **user_key ìƒì„± API** - `/api/docs`ì—ì„œ í™•ì¸ í•„ìš”
- **session_key ìƒì„± API** - `/api/docs`ì—ì„œ í™•ì¸ í•„ìš” (ë˜ëŠ” í”„ë¡ íŠ¸ì—”ë“œì—ì„œ UUID ìƒì„±)

---

## ğŸ› ï¸ ìˆ˜ì • í•„ìš” íŒŒì¼

### 1. `figma_django/web/utils.py`

**ë³€ê²½ ì‚¬í•­**:
- Django session ì €ì¥ í•¨ìˆ˜ ì œê±°
- í”„ë¡ íŠ¸ì—”ë“œìš© ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë¡œ ë³€ê²½ (ì„ íƒì‚¬í•­)

**ìƒˆë¡œìš´ êµ¬ì¡°**:
```python
# web/utils.py
# Django session ì €ì¥ í•¨ìˆ˜ ì œê±°
# í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ê´€ë¦¬í•˜ë¯€ë¡œ ì„œë²„ ì¸¡ í•¨ìˆ˜ ë¶ˆí•„ìš”
```

### 2. `figma_django/web/views.py`

**ë³€ê²½ ì‚¬í•­**:
- `get_or_create_user_id()`, `get_or_create_session_key()` í˜¸ì¶œ ì œê±°
- í…œí”Œë¦¿ì— user_key, session_key ì „ë‹¬í•˜ì§€ ì•ŠìŒ (í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ê´€ë¦¬)

**ìˆ˜ì • ì˜ˆì‹œ**:
```python
# web/views.py
def chat_view(request):
    # user_key, session_keyëŠ” í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ê´€ë¦¬
    return render(request, "web/chat.html")
```

### 3. í”„ë¡ íŠ¸ì—”ë“œ JavaScript íŒŒì¼

**ì¶”ê°€ í•„ìš”**:
- `user_key` ìƒì„±/ê´€ë¦¬ í•¨ìˆ˜
- `session_key` ìƒì„±/ê´€ë¦¬ í•¨ìˆ˜
- API í˜¸ì¶œ í•¨ìˆ˜ë“¤

---

## âœ… ë‹¤ìŒ ë‹¨ê³„

1. **`/api/docs` í™•ì¸** (127.0.0.1:8000/api/docs)
   - user_key ìƒì„± API í™•ì¸
   - session_key ìƒì„± API í™•ì¸
   - ëª¨ë“  API ì—”ë“œí¬ì¸íŠ¸ í™•ì¸

2. **ì½”ë“œ ìˆ˜ì •**
   - `web/utils.py` ìˆ˜ì • (Django session í•¨ìˆ˜ ì œê±°)
   - `web/views.py` ìˆ˜ì • (user_key, session_key ì „ë‹¬ ì œê±°)
   - í”„ë¡ íŠ¸ì—”ë“œ JavaScript ì¶”ê°€ (user_key, session_key ê´€ë¦¬)

3. **í…ŒìŠ¤íŠ¸**
   - API í˜¸ì¶œ í…ŒìŠ¤íŠ¸
   - ì±„íŒ… íˆìŠ¤í† ë¦¬ ì¡°íšŒ í…ŒìŠ¤íŠ¸

---

**ì‘ì„±ì¼**: 2025-01-20  
**ìƒíƒœ**: ê¸´ê¸‰ ë³€ê²½ í•„ìš” âš ï¸  
**ìš°ì„ ìˆœìœ„**: ìµœìš°ì„ 

