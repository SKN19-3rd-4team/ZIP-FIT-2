# 필터 및 태그 개선 설계서

## 1. 개요

### 1.1 목적
- list 페이지의 필터 및 공고 카드 태그를 실제 DB 데이터 구조에 맞게 개선
- 사용자 요구사항에 맞는 필터링 및 표시 기능 구현

### 1.2 범위
- **필터 섹션**: 필터 옵션 변경 및 동적 생성
- **공고 카드 태그**: 태그 구성 변경 및 상태 표시 개선
- **API 응답**: `cnt_new_this_week` 필드 추가

---

## 2. 현재 상태 분석

### 2.1 현재 필터 구조
```
[검색창]
[전체 기관 ▼] [전체 유형 ▼] [전체 상태 ▼]
```

**필터 옵션:**
- **기관**: 전체 기관 | LH | SH | GH
- **유형**: 전체 유형 | 영구임대주택 | 행복주택 | 분양주택 | 전세임대주택 | 매입임대주택 | 국민임대주택 | 통합공공임대주택
- **상태**: 전체 상태 | 공고중 | 접수중 | 마감 | 공고예정

### 2.2 현재 공고 카드 태그 구조
```
[기관태그] [유형태그]                    [상태태그]
```

### 2.3 실제 DB 데이터 구조 (LIST_31.json 분석)

**annc_type 값:**
- "임대" (현재 31개 모두 임대)
- "분양" (현재 데이터 없음, 향후 추가 예정)

**annc_region 값 (31개 데이터 기준):**
- 강원특별자치도
- 경상북도
- 서울특별시 외
- 경상남도
- 충청북도
- 전라남도
- 전국
- 광주광역시 외
- 인천광역시
- 경기도
- 전북특별자치도
- 대구광역시 외

**annc_status 값:**
- "공고중"
- "접수중"
- (제목에 "[정정공고]" 포함 시 정정공고 상태로 판단 필요)

**annc_dtl_type 값:**
- 국민임대
- 행복주택
- 전세임대
- 영구임대
- 매입임대
- 공공임대

---

## 3. 변경 요구사항

### 3.1 필터 변경

#### 변경 전
```
[전체 기관 ▼] [전체 유형 ▼] [전체 상태 ▼]
```

#### 변경 후
```
[전체 유형(분양|임대) ▼] [전체 지역 ▼] [전체 상태 ▼]
```

**필터 옵션:**
1. **전체 유형**: 전체 | 분양 | 임대
   - `annc_type` 필드 값 사용
   - 동적 생성 (API 응답의 고유값 추출)

2. **지역**: 전체 | [DB의 고유 지역값들...]
   - `annc_region` 필드 값 사용
   - **동적 생성**: API 응답에서 고유한 `annc_region` 값 추출하여 자동 생성
   - 예: 강원특별자치도, 경상북도, 서울특별시 외, 전국 등

3. **전체 상태**: 전체 | 공고중 | 접수중 | 마감 | 정정공고중
   - `annc_status` 필드 값 사용
   - 제목에 "[정정공고]" 포함 시 "정정공고중"으로 표시 
   - "공고예정" 옵션은 코드에 유지하되 UI에서 숨김

#### 숨김 처리 (코드 유지)
- **기관 필터**: UI에서 숨김, 코드 유지 (향후 사용 가능)
- **상세 유형 필터** (영구임대주택, 행복주택 등): UI에서 숨김, 코드 유지 (향후 사용 가능)
- **공고예정 상태**: UI에서 숨김, 코드 유지 (향후 사용 가능)

### 3.2 공고 카드 태그 변경

#### 변경 전
```
[기관태그] [유형태그]                    [상태태그]
```

#### 변경 후
```
[기관태그] [유형태그] ->그대로            [상태태그]
```

**태그 구성:**
1. **기관태그**: 유지 (LH, SH, GH)
   - `corp_cd` 또는 URL 기반 추출

2. **지역태그**: 유형태그 → 지역태그로 변경 
-> 공고카드에서는 그대로 유형태그(분양|임대)로 진행하자.
   - `annc_region` 필드 값 사용
   - 예: "강원특별자치도", "경상북도", "서울특별시 외" 등

3. **상태태그**: 개선
   - `annc_status` 필드 값 우선 사용
   - 제목에 "[정정공고]" 포함 시 "정정공고중" 표시 
   -> 태그는 기존 처럼 공고중 | 접수중 | 마감 으로 진행하자.
   - 날짜 기반 동적 계산 로직 유지 (fallback)

---

## 4. 기술 설계

### 4.1 필터 동적 생성 로직

#### 지역 필터 동적 생성
```javascript
// API 응답에서 고유한 annc_region 값 추출
function extractUniqueRegions(announcements) {
    const regions = new Set();
    announcements.forEach(annc => {
        if (annc.annc_region) {
            regions.add(annc.annc_region);
        }
    });
    return Array.from(regions).sort(); // 정렬하여 일관성 유지
}

// 지역 필터 옵션 동적 생성
function populateRegionFilter(regions) {
    const select = document.getElementById('regionFilter');
    select.innerHTML = '<option value="">전체 지역</option>';
    regions.forEach(region => {
        const option = document.createElement('option');
        option.value = region;
        option.textContent = region;
        select.appendChild(option);
    });
}
```

#### 유형 필터 (분양|임대)
```javascript
// API 응답에서 고유한 annc_type 값 추출
function extractUniqueTypes(announcements) {
    const types = new Set();
    announcements.forEach(annc => {
        if (annc.annc_type) {
            types.add(annc.annc_type);
        }
    });
    return Array.from(types).sort();
}

// 유형 필터 옵션 생성
function populateTypeFilter(types) {
    const select = document.getElementById('typeFilter');
    select.innerHTML = '<option value="">전체 유형</option>';
    types.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type; // "임대" 또는 "분양"
        select.appendChild(option);
    });
}
```

### 4.2 필터링 로직

#### 필터 적용 함수
```javascript
function filterAnnouncements() {
    const typeFilter = document.getElementById('typeFilter').value; // "임대" 또는 "분양"
    const regionFilter = document.getElementById('regionFilter').value; // 지역명
    const statusFilter = document.getElementById('statusFilter').value; // 상태값
    
    const filtered = allAnnouncements.filter(annc => {
        // 유형 필터 (annc_type 기반)
        if (typeFilter && annc.annc_type !== typeFilter) {
            return false;
        }
        
        // 지역 필터 (annc_region 기반)
        if (regionFilter && annc.annc_region !== regionFilter) {
            return false;
        }
        
        // 상태 필터 (annc_status 기반, 정정공고 처리 포함)
        if (statusFilter) {
            const currentStatus = getCurrentStatus(annc);
            if (currentStatus !== statusFilter) {
                return false;
            }
        }
        
        return true;
    });
    
    displayAnnouncements(filtered);
}
```

### 4.3 상태 태그 개선

#### 상태 계산 함수 개선
```javascript
function getCurrentStatus(annc) {
    // 1. 정정공고 확인 (제목에 "[정정공고]" 포함)
    if (annc.annc_title && annc.annc_title.includes('[정정공고]')) {
        return '정정공고중';
    }
    
    // 2. annc_status 필드 우선 사용
    if (annc.annc_status) {
        // annc_status 값이 유효하면 사용
        const validStatuses = ['공고중', '접수중', '마감', '공고예정'];
        if (validStatuses.includes(annc.annc_status)) {
            return annc.annc_status;
        }
    }
    
    // 3. 날짜 기반 동적 계산 (fallback)
    if (annc.annc_pblsh_dt && annc.annc_deadline_dt) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const startDate = parseDate(annc.annc_pblsh_dt);
        const endDate = parseDate(annc.annc_deadline_dt);
        
        if (!startDate || !endDate) {
            return annc.annc_status || '공고중';
        }
        
        const diffTime = endDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) return '마감';
        else if (startDate > today) return '공고예정';
        else return '공고중'; // 기본값
    }
    
    // 4. 최종 fallback
    return annc.annc_status || '공고중';
}
```

### 4.4 공고 카드 태그 변경

#### 카드 생성 함수 수정
```javascript
function createAnnouncementCard(annc) {
    // 기관 추출 (기존 로직 유지)
    let agency = 'LH';
    // ... (기존 기관 추출 로직)
    
    // 지역 추출 (annc_region 사용)
    const region = annc.annc_region || '지역 정보 없음';
    
    // 상태 계산 (개선된 getCurrentStatus 사용)
    const statusText = getCurrentStatus(annc);
    
    // ... (카드 HTML 생성)
    card.innerHTML = `
        <div class="announcement-header">
            <div>
                <span class="agency-badge agency-${agency.toLowerCase()}">${agency}</span>
                <span class="region-badge">${region}</span> <!-- 유형태그 → 지역태그 -->
            </div>
            <span class="status-badge ${getStatusClass(statusText)}">${statusText}</span>
        </div>
        ...
    `;
}
```

### 4.5 API 응답 개선

#### annc_summary API에 cnt_new_this_week 추가
```python
@api_view(['GET'])
def annc_summary(request):
    from datetime import datetime, timedelta
    
    total = AnncAll.objects.count()
    lease = AnncAll.objects.filter(annc_type="임대").count()
    sale = AnncAll.objects.filter(annc_type="분양").count()
    etc = total - (lease + sale)
    
    # 이번 주 신규 공고 계산
    today = datetime.now().date()
    week_ago = today - timedelta(days=7)
    new_this_week = AnncAll.objects.filter(
        created_at__gte=week_ago,
        created_at__lt=today + timedelta(days=1)
    ).count()
    
    response_data = {
        "message": "성공적으로 공고 요약 정보를 조회했습니다.",
        "status": "success",
        "data": {
            "cnt_total": total,
            "cnt_lease": lease,
            "cnt_sale": sale,
            "cnt_etc": etc if etc >= 0 else 0,
            "cnt_new_this_week": new_this_week  # 추가
        }
    }
    return Response(response_data)
```

---

## 5. UI/UX 변경사항

### 5.1 필터 섹션

#### HTML 구조 변경
```html
<div class="filter-group">
    <!-- 기관 필터: 숨김 처리 (display: none) -->
    <select class="filter-select" id="agencyFilter" style="display: none;" onchange="filterAnnouncements()">
        <option value="">전체 기관</option>
        <option value="LH">LH 한국토지주택공사</option>
        <option value="SH">SH 서울주택도시공사</option>
        <option value="GH">GH 경기주택도시공사</option>
    </select>

    <!-- 유형 필터: 변경 (분양|임대) -->
    <select class="filter-select" id="typeFilter" onchange="filterAnnouncements()">
        <option value="">전체 유형</option>
        <!-- 동적으로 생성: 분양, 임대 -->
    </select>

    <!-- 지역 필터: 신규 추가 -->
    <select class="filter-select" id="regionFilter" onchange="filterAnnouncements()">
        <option value="">전체 지역</option>
        <!-- 동적으로 생성: DB의 고유 지역값들 -->
    </select>

    <!-- 상태 필터: 변경 (정정공고중 추가, 공고예정 숨김) -->
    <select class="filter-select" id="statusFilter" onchange="filterAnnouncements()">
        <option value="">전체 상태</option>
        <option value="공고중">공고중</option>
        <option value="접수중">접수중</option>
        <option value="마감">마감</option>
        <option value="정정공고중">정정공고중</option>
        <!-- 공고예정: 숨김 처리 (display: none) -->
        <option value="공고예정" style="display: none;">공고예정</option>
    </select>
</div>
```

### 5.2 공고 카드 태그

#### CSS 클래스 추가
```css
.region-badge {
    /* 기존 .type-badge 스타일 재사용 또는 새로 정의 */
    background: #f0f9ff;
    color: #0369a1;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}
```

---

## 6. 구현 단계

### Phase 1: 필터 변경
1. ✅ HTML 구조 변경 (기관 필터 숨김, 지역 필터 추가)
2. ✅ 필터 옵션 동적 생성 로직 구현
3. ✅ 필터링 로직 수정 (annc_type, annc_region 기반)

### Phase 2: 태그 변경
1. ✅ 공고 카드 생성 함수 수정 (유형태그 → 지역태그)
2. ✅ 상태 태그 로직 개선 (annc_status 우선, 정정공고 처리)

### Phase 3: API 개선
1. ✅ annc_summary API에 cnt_new_this_week 추가
2. ✅ 프론트엔드에서 cnt_new_this_week 사용

### Phase 4: 테스트 및 검증
1. ✅ 필터 동작 테스트
2. ✅ 태그 표시 테스트
3. ✅ 동적 필터 생성 테스트 (새 지역 추가 시)

---

## 7. 확인 사항

### 7.1 API 명세 확인
- [ ] `docs/api/api.yaml`과 실제 `views.py` 구현 일치 여부 확인
- [ ] `cnt_new_this_week` 필드가 API 명세에 포함되어 있는지 확인

### 7.2 데이터 일관성
- [ ] `annc_status` 값의 일관성 확인
- [ ] `annc_region` 값의 정규화 필요 여부 확인 (예: "서울특별시 외" vs "서울 외")
-> 만약 프론트엔드 단에서 가능하다면 정규화도 좋은 생각이라고 생각함.
다만, 지속적인 데이터가 들어올때마다 진행하는 어려움이 있을거라고 생각함.
우리가 추가적으로 쌓을 데이터는 약 1,000개 이상이 될 것으로 파악된다.
그래서 해당 데이터를 기준으로 정규화를 한 번해도 사실상 나중에 공고로 올라오는 것에
크게 변함이 있지는 않을 것 같다.
왜냐하면 공공 주택에 관한 데이터가 데이터 성격 상 규격 형식 등이 크게 달라지지 않을 것이기 때문이다.

### 7.3 성능 고려사항
- [ ] 동적 필터 생성 시 성능 영향 최소화
- [ ] 대량 데이터 시 필터 옵션 생성 최적화

---

## 8. 질문 및 확인 필요 사항

### 8.1 상태 관련
1. **정정공고 상태 표시**: 제목에 "[정정공고]" 포함 시 "정정공고중"으로 표시하는 것이 맞나요?
-> 태그는 기존 처럼 공고중 | 접수중 | 마감 으로 진행하자.
상태 관련이라는 것이 지금 태그 때문에 묻는 것이 아닌가?
정정공고의 경우 제목 앞에 [정정공고]라고 표기 되어있을 것이고, 상태는 공고중|접수중|마감or공고마감|정정공고중 이렇게 api에서 불러올 것으로 생각한다.
2. **상태 우선순위**: `annc_status` 필드 값과 날짜 기반 계산 결과가 다를 경우 어떤 것을 우선하나요?
무조건 annc_status 를 따른다. 우리가 크롤링해서 데이터베이스에 저장한 값을 우선 따른다.
### 8.2 지역 관련
1. **지역 정규화**: "서울특별시 외", "대구광역시 외", "광주광역시 외" 같은 값들을 그대로 사용할까요, 아니면 정규화가 필요할까요?
정규화 하면 좋을 것 같지만, 위에서 언급하긴 했지만, 우리 최종 전체 데이터를 보고서 어떤식으로 진행하는 것이 좋은지 파악하기 바랍니다.
2. **지역 정렬**: 지역 필터 옵션의 정렬 기준은 무엇인가요? (알파벳 순, 사용 빈도 순 등)
-> 일반적 어플이나 웹에서 추구하는 방향성이면 될 것 같다.
### 8.3 필터 관련
1. **기관 필터**: 향후 사용 시 UI에 다시 표시할 예정인가요?
-> 네, 현재는 사용하지 않습니다. 이유: 현재는 MVP 로 LH 공고만을 불러와서 서비스를 진행
그러나 추후에 GH, SH 까지 범위를 확장할 것이기 때문에 현재는 UI에서만 표시를 하지 않고 추후에 개발이 진행되면 다시 표시할 예정입니다.
2. **상세 유형 필터**: 향후 사용 시 UI에 다시 표시할 예정인가요?
공고예정 -> 이 것도 현재는 사용하지 않지만, 나중에는 실제 공고 예정인 데이터들도 DB에 저장해서 진행할 예정입니다. MVP에서는 우선 기능적인 부분을 빼고 진행합니다. 다만 삭제는 하지 않습니다.
---

## 9. 예상 작업 시간

- 필터 변경: 2-3시간
- 태그 변경: 1-2시간
- API 개선: 30분
- 테스트 및 검증: 1-2시간
- **총 예상 시간: 4-7시간**

---

## 10. 참고 자료

- `lab/ohj/LIST_31.json`: 실제 DB 데이터 구조
- `lab/ohj/각 API 호출 결과.md`: API 응답 형식
- `docs/api/api.yaml`: API 명세서
- `zf_django/web/templates/web/list.html`: 현재 구현 코드

